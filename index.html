<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CloudHost Support ‚Äî Issue Tracker (Public)</title>
  <style>
    :root{
      --bg0:#0b1220;
      --bg1:#0e1b33;
      --card:#0f1a2e;
      --card2:#0c1627;
      --text:#e9eefc;
      --muted:#a8b4d6;
      --line:rgba(255,255,255,.10);
      --brand:#7c5cff;
      --brand2:#3dd6ed;
      --good:#34d399;
      --bad:#fb7185;
      --warn:#fbbf24;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --shadow2: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(900px 500px at 20% 10%, rgba(124,92,255,.35), transparent 55%),
        radial-gradient(900px 500px at 90% 20%, rgba(61,214,237,.25), transparent 55%),
        radial-gradient(900px 700px at 40% 90%, rgba(52,211,153,.14), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    a{ color:inherit; text-decoration:none; }
    button, input, select, textarea{ font:inherit; }

    .wrap{ max-width:1100px; margin:0 auto; padding:26px 18px 48px; }

    /* Topbar */
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:14px; padding:14px 16px;
      border:1px solid var(--line);
      border-radius: 22px;
      background: rgba(15,26,46,.62);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
    }
    .brand{
      display:flex; align-items:center; gap:12px; min-width:220px;
    }
    .logo{
      width:38px; height:38px; border-radius:14px;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 12px 30px rgba(124,92,255,.25);
      position:relative;
    }
    .logo::after{
      content:"";
      position:absolute; inset:10px;
      border-radius:10px;
      background: rgba(255,255,255,.18);
      transform: rotate(12deg);
    }
    .brand h1{
      font-size:14px; margin:0; letter-spacing:.4px; font-weight:700;
    }
    .brand p{ margin:2px 0 0; color:var(--muted); font-size:12px; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(12,22,39,.55);
      color: var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .dot{
      width:8px; height:8px; border-radius:999px; background: var(--good);
      box-shadow: 0 0 0 6px rgba(52,211,153,.16);
    }

    .userbox{
      display:flex; align-items:center; gap:10px;
      min-width: 220px;
      justify-content:flex-end;
    }
    .avatar{
      width:34px; height:34px; border-radius:12px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.08);
      border:1px solid var(--line);
      color: var(--text);
      font-weight:700;
      user-select:none;
    }
    .usertext{ text-align:right; }
    .usertext .name{ font-size:12px; font-weight:700; margin:0; }
    .usertext .sub{ font-size:12px; margin:2px 0 0; color:var(--muted); }

    /* Hero */
    .hero{
      margin-top:18px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(15,26,46,.50);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .heroGrid{
      display:grid; grid-template-columns: 1.2fr .8fr;
      gap:0;
    }
    .heroLeft{
      padding:22px 22px 18px;
      border-right: 1px solid var(--line);
    }
    .heroLeft h2{
      margin:0 0 10px;
      font-size: 28px;
      letter-spacing: .2px;
      line-height: 1.15;
    }
    .heroLeft p{
      margin:0 0 16px;
      color: var(--muted);
      line-height: 1.55;
      max-width: 62ch;
    }

    .actionsRow{
      display:flex; gap:12px; align-items:center; justify-content:center;
      padding: 14px 0 4px;
      flex-wrap: wrap;
    }
    .btn{
      border:1px solid var(--line);
      background: rgba(12,22,39,.55);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 14px;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:10px;
      transition: transform .08s ease, background .18s ease, border-color .18s ease;
      user-select:none;
      box-shadow: 0 10px 25px rgba(0,0,0,.18);
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.20); background: rgba(12,22,39,.72); }
    .btn:active{ transform: translateY(0); }
    .btnPrimary{
      background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(61,214,237,.88));
      border-color: rgba(255,255,255,.16);
      box-shadow: 0 16px 40px rgba(124,92,255,.22);
    }
    .btnPrimary:hover{ background: linear-gradient(135deg, rgba(124,92,255,1), rgba(61,214,237,.95)); }

    .btnAttention{
      background: radial-gradient(120% 140% at 10% 10%, rgba(251,191,36,.95), rgba(124,92,255,.75));
      border-color: rgba(255,255,255,.18);
      box-shadow: 0 18px 45px rgba(251,191,36,.16), 0 18px 45px rgba(124,92,255,.16);
      transform: translateY(-1px);
    }
    .btnAttention:hover{
      transform: translateY(-2px);
      background: radial-gradient(120% 140% at 10% 10%, rgba(251,191,36,1), rgba(124,92,255,.82));
    }

    .icon{
      width:18px; height:18px; display:inline-block;
      opacity:.95;
    }

    .heroRight{
      padding:20px;
      background: rgba(12,22,39,.30);
    }
    .miniCard{
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(12,22,39,.55);
      padding:14px;
    }
    .miniCard h3{
      margin:0 0 8px;
      font-size:14px;
      letter-spacing:.2px;
    }
    .miniCard p{ margin:0; color:var(--muted); font-size:12.5px; line-height:1.5; }
    .creds{
      margin-top:12px;
      padding:12px;
      border-radius: 14px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-size: 12.5px;
      display:none;
    }
    .creds strong{ color: var(--text); }
    .creds code{
      color: var(--text);
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      padding:2px 8px;
      border-radius:999px;
    }
    .creds ul{ margin:10px 0 0; padding-left: 18px; }
    .creds li{ margin:6px 0; }

    /* Main content */
    .main{
      margin-top:16px;
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
    }
    .card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(15,26,46,.50);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .cardHeader{
      padding:16px 18px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
    }
    .cardHeader h3{ margin:0; font-size:14px; letter-spacing:.3px; }
    .cardHeader p{ margin:0; color:var(--muted); font-size:12px; }

    .cardBody{ padding:18px; }

    /* Form */
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .field{ display:flex; flex-direction:column; gap:8px; }
    .labelRow{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    label{ font-size:12px; color: var(--muted); }
    .hint{ font-size:12px; color: var(--muted); opacity:.9; }
    input[type="text"], select, textarea{
      width:100%;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(12,22,39,.55);
      color: var(--text);
      padding: 12px 12px;
      outline:none;
      transition: border-color .18s ease, transform .08s ease;
    }
    textarea{ min-height: 112px; resize: vertical; }
    input[type="text"]:focus, select:focus, textarea:focus{
      border-color: rgba(124,92,255,.55);
      box-shadow: 0 0 0 5px rgba(124,92,255,.14);
    }

    .formActions{
      display:flex; align-items:center; gap:10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .statusMsg{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(12,22,39,.45);
      display:none;
      font-size: 13px;
      line-height: 1.45;
    }
    .statusMsg.good{ border-color: rgba(52,211,153,.25); color: var(--good); display:block; }
    .statusMsg.bad{ border-color: rgba(251,113,133,.25); color: var(--bad); display:block; }

    /* Tickets */
    .ticketsTop{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
    }
    .ticketsTop .left p{ margin:6px 0 0; color:var(--muted); font-size:12.5px; }
    .ticketsTop .right{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(12,22,39,.50);
      color: var(--muted);
      font-size:12px;
    }

    .ticketsList{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    .ticket{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(12,22,39,.50);
      border-radius: 16px;
      overflow:hidden;
    }
    .ticketHead{
      padding: 14px 14px 12px;
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px;
      cursor:pointer;
    }
    .ticketTitle{
      display:flex; flex-direction:column; gap:6px;
      min-width:0;
    }
    .ticketTitle .subj{
      font-weight:700; font-size: 14px;
      letter-spacing: .2px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 64ch;
    }
    .ticketTitle .meta{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      color: var(--muted); font-size: 12px;
    }
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .tag.good{ color: var(--good); border-color: rgba(52,211,153,.20); background: rgba(52,211,153,.06); }
    .tag.warn{ color: var(--warn); border-color: rgba(251,191,36,.20); background: rgba(251,191,36,.06); }
    .tag.bad{ color: var(--bad); border-color: rgba(251,113,133,.22); background: rgba(251,113,133,.06); }

    .ticketBody{
      border-top:1px solid rgba(255,255,255,.08);
      padding: 14px;
      display:none;
    }
    .ticketBody.open{ display:block; }
    .ticketGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    .box{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      background: rgba(15,26,46,.35);
      padding: 12px;
    }
    .box h4{
      margin:0 0 8px;
      font-size: 12px;
      color: var(--muted);
      letter-spacing:.3px;
      text-transform: uppercase;
    }
    .box p{
      margin:0;
      color: var(--text);
      font-size: 13px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .row{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
    }
    .row .left{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row .right{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .smallBtn{
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 12.5px;
    }
    .smallBtnGhost{
      background: rgba(12,22,39,.35);
      border-color: rgba(255,255,255,.10);
      box-shadow:none;
    }

    .divider{ height:1px; background: rgba(255,255,255,.08); margin: 12px 0; }

    .replyList{
      display:flex; flex-direction:column; gap:10px;
    }
    .bubble{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(12,22,39,.55);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .bubble .meta{
      color: var(--muted);
      font-size: 11.5px;
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      margin-bottom:6px;
    }
    .bubble .text{
      margin:0;
      font-size: 13px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* Modal */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modal{
      width:min(520px, 100%);
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(15,26,46,.92);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding: 14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .modalHead h3{ margin:0; font-size:14px; letter-spacing:.2px; }
    .modalHead button{
      background: transparent; border:1px solid rgba(255,255,255,.12);
      color: var(--text);
      width: 36px; height: 36px;
      border-radius: 14px;
      cursor:pointer;
    }
    .modalBody{ padding: 16px; }
    .modalNote{
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.55;
      margin: 0 0 12px;
    }

    /* Footer */
    .footer{
      margin-top: 16px;
      color: rgba(233,238,252,.65);
      font-size: 12px;
      text-align:center;
    }

    /* Responsive */
    @media (max-width: 900px){
      .heroGrid{ grid-template-columns: 1fr; }
      .heroLeft{ border-right:none; border-bottom:1px solid var(--line); }
      .brand{ min-width:unset; }
      .userbox{ min-width:unset; }
      .ticketTitle .subj{ max-width: 42ch; }
    }
    @media (max-width: 640px){
      .grid2{ grid-template-columns: 1fr; }
      .topbar{ padding:12px 12px; border-radius: 18px; }
      .heroLeft h2{ font-size: 24px; }
      .ticketTitle .subj{ max-width: 28ch; }
      .actionsRow{ justify-content: center; }
      .btn{ width: 100%; justify-content:center; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>CloudHost Support</h1>
          <p>Public Issue Tracker</p>
        </div>
      </div>

      <div class="pill" title="Real-time updates are enabled once Firestore is turned on.">
        <span class="dot" aria-hidden="true"></span>
        <span id="pillText">Guest ‚Äî login required</span>
      </div>

      <div class="userbox">
        <div class="usertext">
          <p class="name" id="userName">Not signed in</p>
          <p class="sub" id="userSub">Use demo accounts to proceed</p>
        </div>
        <div class="avatar" id="avatar">?</div>
      </div>
    </div>

    <section class="hero">
      <div class="heroGrid">
        <div class="heroLeft">
          <h2>Report an issue in seconds. Track it until it's resolved.</h2>
          <p>
            This portal is for existing CloudHost customers (domain or hosting).
            Login first, then create a ticket. Your tickets will appear under your account,
            and you can reply if the support team responds.
          </p>

          <div class="actionsRow">
            <button class="btn btnAttention" id="loginBtn">
              <span class="icon" aria-hidden="true">üîê</span>
              LOGIN
            </button>
            <button class="btn btnPrimary" id="createTicketBtn">
              <span class="icon" aria-hidden="true">‚ûï</span>
              Create a Ticket
            </button>
          </div>

          <div class="statusMsg" id="globalMsg"></div>
        </div>

        <div class="heroRight">
          <div class="miniCard">
            <h3>Example ticket (from another customer)</h3>
            <p>This is a sample ticket shown on the homepage to demonstrate the format.</p>

            <div style="margin-top:12px" class="ticket" aria-label="Example ticket">
              <div class="ticketHead" style="cursor:default">
                <div class="ticketTitle">
                  <div class="subj" id="exampleSubject">SSL certificate warning after renewal</div>
                  <div class="meta">
                    <span class="tag warn" id="exampleUrgency">Urgency: Medium</span>
                    <span class="tag" id="exampleStatus">Status: In Progress</span>
                    <span class="tag" id="exampleTime">Created: ‚Äî</span>
                  </div>
                </div>
                <div class="tag" title="Example only">Preview</div>
              </div>
            </div>

            <div class="creds" id="credsBox">
              <strong>Demo login credentials</strong> (password is the same for all):
              <div style="margin-top:10px">
                Password: <code>0000</code>
              </div>
              <ul>
                <li><code>user1@example.com</code></li>
                <li><code>user2@example.com</code></li>
                <li><code>user3@example.com</code></li>
              </ul>
              <p style="margin-top:10px">
                Each account can only see and edit its own tickets.
              </p>
            </div>

            <button class="btn" style="width:100%; justify-content:center; margin-top:12px" id="showCredsBtn">
              <span class="icon" aria-hidden="true">‚ÑπÔ∏è</span>
              Show demo credentials
            </button>
          </div>
        </div>
      </div>
    </section>

    <main class="main">
      <!-- Create Ticket -->
      <section class="card" id="createCard">
        <div class="cardHeader">
          <div>
            <h3>Create a new ticket</h3>
            <p>Login is required. No name or email needed ‚Äî we link tickets to your account.</p>
          </div>
          <div class="pill" title="Tickets are stored locally for now. You can turn on Firestore later.">
            <span aria-hidden="true">üóÉÔ∏è</span>
            <span id="storageMode">Storage: Local (DB can be enabled later)</span>
          </div>
        </div>
        <div class="cardBody">
          <form id="ticketForm">
            <div class="grid2">
              <div class="field">
                <div class="labelRow">
                  <label for="subject">Subject</label>
                  <span class="hint">Required</span>
                </div>
                <input id="subject" type="text" maxlength="80" placeholder="e.g., My website is down / DNS not resolving" />
              </div>

              <div class="field">
                <div class="labelRow">
                  <label for="urgency">Urgency</label>
                  <span class="hint">Required</span>
                </div>
                <select id="urgency">
                  <option value="">Select urgency</option>
                  <option value="Low">Low</option>
                  <option value="Medium">Medium</option>
                  <option value="High">High</option>
                </select>
              </div>
            </div>

            <div class="field" style="margin-top:12px">
              <div class="labelRow">
                <label for="description">Description</label>
                <span class="hint">Required</span>
              </div>
              <textarea id="description" placeholder="Describe the issue briefly and clearly..."></textarea>
            </div>

            <div class="formActions">
              <button class="btn btnPrimary" type="submit" id="submitBtn">
                <span class="icon" aria-hidden="true">üì®</span>
                Submit Ticket
              </button>
              <button class="btn smallBtn smallBtnGhost" type="button" id="clearBtn">
                Clear
              </button>
              <span class="hint" id="loginHint" style="display:none">
                You must login before submitting.
              </span>
            </div>

            <div class="statusMsg" id="formMsg"></div>
          </form>
        </div>
      </section>

      <!-- My Tickets -->
      <section class="card" id="ticketsCard">
        <div class="cardHeader">
          <div class="ticketsTop">
            <div class="left">
              <h3>My tickets</h3>
              <p>Click a ticket to view details, edit it, or reply to staff messages.</p>
            </div>
            <div class="right">
              <span class="chip" id="countChip">0 tickets</span>
              <button class="btn smallBtn smallBtnGhost" id="logoutBtn" title="Logout">
                <span class="icon" aria-hidden="true">üö™</span>
                Logout
              </button>
            </div>
          </div>
        </div>
        <div class="cardBody">
          <div class="ticketsList" id="ticketsList"></div>
          <div class="statusMsg" id="ticketsMsg"></div>
        </div>
      </section>
    </main>

    <div class="footer">
      Tip: This page is intentionally a single self-contained HTML file (HTML + CSS + JS). Firestore can be enabled later.
    </div>
  </div>

  <!-- LOGIN MODAL -->
  <div class="modalOverlay" id="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <div class="modal">
      <div class="modalHead">
        <h3 id="loginTitle">Login</h3>
        <button id="closeModalBtn" aria-label="Close">‚úï</button>
      </div>
      <div class="modalBody">
        <p class="modalNote">
          Use one of the demo accounts below. Password is <strong>0000</strong> for all users.
          After login, you will only see your own tickets.
        </p>

        <div class="grid2">
          <div class="field">
            <label for="emailSelect">Username (email)</label>
            <select id="emailSelect">
              <option value="user1@example.com">user1@example.com</option>
              <option value="user2@example.com">user2@example.com</option>
              <option value="user3@example.com">user3@example.com</option>
            </select>
          </div>
          <div class="field">
            <label for="passwordInput">Password</label>
            <input id="passwordInput" type="text" inputmode="numeric" maxlength="4" placeholder="0000" />
          </div>
        </div>

        <div class="formActions" style="margin-top:14px">
          <button class="btn btnPrimary" id="doLoginBtn">
            <span class="icon" aria-hidden="true">‚úÖ</span>
            Sign in
          </button>
          <button class="btn smallBtn smallBtnGhost" id="fillPassBtn" type="button">
            Fill password (0000)
          </button>
        </div>

        <div class="statusMsg" id="loginMsg"></div>
      </div>
    </div>
  </div>

  <script type="module">
  // Firebase (Web SDK) imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore, collection, addDoc, getDocs,
    query, where, orderBy, doc, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ‚úÖ Your web app's Firebase configuration (DO NOT use service account in frontend)
  const firebaseConfig = {
    apiKey: "AIzaSyCjXjoxwzs5aq2aV5308Akjs2xia-r-XxE",
    authDomain: "final-project-75dde.firebaseapp.com",
    projectId: "final-project-75dde",
    storageBucket: "final-project-75dde.firebasestorage.app",
    messagingSenderId: "750259875804",
    appId: "1:750259875804:web:4d7a2be29d6bf834b3e919"
  };

  const app = initializeApp(firebaseConfig);

  // ‚úÖ Turn Firestore ON
  const USE_FIRESTORE = true;

  // Firestore handle
  const db = getFirestore(app);
  const TICKETS_COL = "tickets";

  // Local storage keys (still used for login session only)
  const LS_USER = "cloudhost_public_user_v1";

  const DEMO_USERS = new Set(["user1@example.com","user2@example.com","user3@example.com"]);
  const DEMO_PASS = "0000";

  function nowISO(){ return new Date().toISOString(); }
  function fmtDate(iso){
    try{
      const d = new Date(iso);
      return d.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }catch{ return "‚Äî"; }
  }
  function userInitial(email){ return (email || "?").trim().slice(0,1).toUpperCase() || "?"; }

  function getCurrentUser(){
    try{
      const raw = localStorage.getItem(LS_USER);
      if (!raw) return null;
      const u = JSON.parse(raw);
      if (!u || !u.email) return null;
      if (!DEMO_USERS.has(u.email)) return null;
      return u;
    }catch{ return null; }
  }
  function setCurrentUser(email){
    localStorage.setItem(LS_USER, JSON.stringify({ email, at: nowISO() }));
  }
  function clearCurrentUser(){
    localStorage.removeItem(LS_USER);
  }

  function computeIsHighPriority(urgency){ return urgency === "High"; }
  function validateTicketInput({subject, description, urgency}){
    const errors = [];
    if (!subject || subject.trim().length < 4) errors.push("Subject must be at least 4 characters.");
    if (!urgency) errors.push("Please select an urgency level.");
    if (!description || description.trim().length < 12) errors.push("Description must be at least 12 characters.");
    return errors;
  }

  // ---------- Firestore CRUD ----------
  async function fsCreateTicket({ userEmail, subject, description, urgency }) {
    const docRef = await addDoc(collection(db, TICKETS_COL), {
      userEmail,
      subject,
      description,
      urgency,
      status: "New",
      isHighPriority: computeIsHighPriority(urgency),
      staffResponse: "",
      staffRespondedAt: null,
      customerReplies: [],
      createdAt: nowISO(),     // keep as ISO string for simplicity
      updatedAt: nowISO()
    });
    return docRef.id;
  }

  async function fsGetMyTickets(userEmail) {
    const q = query(
      collection(db, TICKETS_COL),
      where("userEmail", "==", userEmail),
      orderBy("createdAt", "desc")
    );
    const snap = await getDocs(q);
    return snap.docs.map(d => ({ id: d.id, ...d.data() }));
  }

  async function fsUpdateTicket(ticketId, patch) {
    const ref = doc(db, TICKETS_COL, ticketId);
    await updateDoc(ref, { ...patch, updatedAt: nowISO() });
  }

  // ---------- UI Hooks (IDs must match your HTML) ----------
  const pillText = document.getElementById("pillText");
  const userName = document.getElementById("userName");
  const userSub  = document.getElementById("userSub");
  const avatar   = document.getElementById("avatar");

  const loginBtn = document.getElementById("loginBtn");
  const createTicketBtn = document.getElementById("createTicketBtn");
  const globalMsg = document.getElementById("globalMsg");

  const ticketForm = document.getElementById("ticketForm");
  const subjectEl = document.getElementById("subject");
  const urgencyEl = document.getElementById("urgency");
  const descEl = document.getElementById("description");
  const formMsg = document.getElementById("formMsg");
  const loginHint = document.getElementById("loginHint");
  const clearBtn = document.getElementById("clearBtn");

  const ticketsList = document.getElementById("ticketsList");
  const ticketsMsg  = document.getElementById("ticketsMsg");
  const countChip   = document.getElementById("countChip");
  const logoutBtn   = document.getElementById("logoutBtn");

  // Modal
  const modalOverlay = document.getElementById("modalOverlay");
  const closeModalBtn = document.getElementById("closeModalBtn");
  const doLoginBtn = document.getElementById("doLoginBtn");
  const fillPassBtn = document.getElementById("fillPassBtn");
  const emailSelect = document.getElementById("emailSelect");
  const passwordInput = document.getElementById("passwordInput");
  const loginMsg = document.getElementById("loginMsg");

  const storageMode = document.getElementById("storageMode");
  if (storageMode) storageMode.textContent = USE_FIRESTORE ? "Storage: Firestore (enabled)" : "Storage: Local";

  function showMessage(el, type, text){
    el.classList.remove("good","bad");
    if (!text){
      el.style.display = "none";
      el.textContent = "";
      return;
    }
    el.textContent = text;
    el.classList.add(type === "good" ? "good" : "bad");
    el.style.display = "block";
  }

  function openModal(){
    showMessage(loginMsg, "bad", "");
    passwordInput.value = "";
    modalOverlay.style.display = "flex";
    setTimeout(() => passwordInput.focus(), 50);
  }
  function closeModal(){ modalOverlay.style.display = "none"; }
  function scrollToCreate(){
    document.getElementById("createCard")?.scrollIntoView({ behavior:"smooth", block:"start" });
  }

  function updateTopbar(){
    const u = getCurrentUser();
    if (!u){
      pillText.textContent = "Guest ‚Äî login required";
      userName.textContent = "Not signed in";
      userSub.textContent  = "Use demo accounts to proceed";
      avatar.textContent = "?";
      return;
    }
    pillText.textContent = "Signed in";
    userName.textContent = u.email;
    userSub.textContent  = "You can create and manage your tickets";
    avatar.textContent = userInitial(u.email);
  }

  function enforceLoginUI(){
    const u = getCurrentUser();
    const isLoggedIn = !!u;

    loginHint.style.display = isLoggedIn ? "none" : "inline";
    subjectEl.disabled = !isLoggedIn;
    urgencyEl.disabled = !isLoggedIn;
    descEl.disabled = !isLoggedIn;

    if (!isLoggedIn){
      showMessage(globalMsg, "bad", "Login is required before you can submit a ticket.");
    } else {
      showMessage(globalMsg, "bad", "");
    }
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  async function renderTickets(){
    const u = getCurrentUser();
    ticketsList.innerHTML = "";

    if (!u){
      countChip.textContent = "0 tickets";
      ticketsList.innerHTML = `
        <div class="miniCard" style="border-radius:16px">
          <h3 style="margin:0 0 8px">Login required</h3>
          <p>Please login to view your tickets and create new ones.</p>
        </div>`;
      return;
    }

    try{
      const mine = await fsGetMyTickets(u.email);
      countChip.textContent = `${mine.length} ticket${mine.length === 1 ? "" : "s"}`;

      if (mine.length === 0){
        ticketsList.innerHTML = `
          <div class="miniCard" style="border-radius:16px">
            <h3 style="margin:0 0 8px">No tickets yet</h3>
            <p>Create your first ticket using the form above.</p>
          </div>`;
        return;
      }

      for (const t of mine){
        const statusTag = t.status === "Completed" ? "good" : (t.status === "In Progress" ? "warn" : "");
        const urgTag = t.urgency === "High" ? "bad" : (t.urgency === "Medium" ? "warn" : "");
        const highPri = t.isHighPriority ? `<span class="tag bad">High priority</span>` : "";
        const staffText = (t.staffResponse && t.staffResponse.trim()) ? t.staffResponse.trim() : "No staff response yet.";

        const replies = Array.isArray(t.customerReplies) ? t.customerReplies : [];
        const repliesHtml = replies.length
          ? replies.map(r => `
              <div class="bubble">
                <div class="meta"><span>You</span><span>${fmtDate(r.at)}</span></div>
                <p class="text">${escapeHtml(r.text)}</p>
              </div>`).join("")
          : `<p class="hint" style="margin:0">No replies from you yet.</p>`;

        const el = document.createElement("div");
        el.className = "ticket";
        el.innerHTML = `
          <div class="ticketHead" data-id="${t.id}">
            <div class="ticketTitle">
              <div class="subj" title="${escapeHtml(t.subject)}">${escapeHtml(t.subject)}</div>
              <div class="meta">
                <span class="tag ${urgTag}">Urgency: ${escapeHtml(t.urgency)}</span>
                <span class="tag ${statusTag}">Status: ${escapeHtml(t.status)}</span>
                ${highPri}
                <span class="tag">Updated: ${fmtDate(t.updatedAt || t.createdAt)}</span>
              </div>
            </div>
            <div class="tag" aria-hidden="true">Details ‚ñæ</div>
          </div>

          <div class="ticketBody" id="body_${t.id}">
            <div class="ticketGrid">
              <div class="box">
                <h4>Description</h4>
                <p>${escapeHtml(t.description)}</p>
              </div>

              <div class="box">
                <h4>Support response</h4>
                <p>${escapeHtml(staffText)}</p>
              </div>

              <div class="box">
                <h4>Your replies</h4>
                <div class="replyList">${repliesHtml}</div>
                <div class="divider"></div>
                <div class="field">
                  <label for="reply_${t.id}">Add a reply to support</label>
                  <textarea id="reply_${t.id}" placeholder="Write your reply..."></textarea>
                </div>
                <div class="row" style="margin-top:10px">
                  <div class="left">
                    <button class="btn smallBtn btnPrimary" data-action="addReply" data-id="${t.id}">
                      üí¨ Send reply
                    </button>
                  </div>
                </div>
                <div class="statusMsg" id="msg_${t.id}"></div>
              </div>
            </div>
          </div>`;

        ticketsList.appendChild(el);
      }

      ticketsList.querySelectorAll(".ticketHead").forEach(head => {
        head.addEventListener("click", () => {
          const id = head.getAttribute("data-id");
          const body = document.getElementById("body_" + id);
          body.classList.toggle("open");
          const chevron = head.querySelector(".tag:last-child");
          chevron.textContent = body.classList.contains("open") ? "Details ‚ñ¥" : "Details ‚ñæ";
        });
      });

      ticketsList.querySelectorAll("button[data-action='addReply']").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          e.stopPropagation();
          const id = btn.getAttribute("data-id");
          const msgEl = document.getElementById("msg_" + id);
          const ta = document.getElementById("reply_" + id);
          const text = (ta.value || "").trim();
          if (text.length < 3){
            showMessage(msgEl, "bad", "Reply is too short.");
            return;
          }

          // read latest (simple approach: append reply without fetching full doc)
          // We'll append to existing array by reading visible state is hard; easiest is to use Firestore arrayUnion,
          // but to keep it simple we re-fetch and then update.
          const mine = await fsGetMyTickets(getCurrentUser().email);
          const ticket = mine.find(x => x.id === id);
          const replies = Array.isArray(ticket?.customerReplies) ? ticket.customerReplies : [];
          replies.push({ text, at: nowISO() });

          await fsUpdateTicket(id, { customerReplies: replies });
          ta.value = "";
          showMessage(msgEl, "good", "Reply sent successfully.");
          await renderTickets();
        });
      });

    } catch (err){
      console.error(err);
      showMessage(ticketsMsg, "bad", "Could not load tickets. Check Firestore rules and project configuration.");
    }
  }

  // ---------- Events ----------
  loginBtn.addEventListener("click", openModal);
  createTicketBtn.addEventListener("click", () => {
    const u = getCurrentUser();
    if (!u){ showMessage(globalMsg, "bad", "Please login before creating a ticket."); openModal(); return; }
    scrollToCreate();
    subjectEl.focus();
  });

  modalOverlay.addEventListener("click", (e) => { if (e.target === modalOverlay) closeModal(); });
  closeModalBtn.addEventListener("click", closeModal);
  fillPassBtn.addEventListener("click", () => { passwordInput.value = "0000"; passwordInput.focus(); });

  doLoginBtn.addEventListener("click", async () => {
    const email = (emailSelect.value || "").trim();
    const pass = (passwordInput.value || "").trim();

    if (!DEMO_USERS.has(email)){ showMessage(loginMsg, "bad", "Invalid user."); return; }
    if (pass !== DEMO_PASS){ showMessage(loginMsg, "bad", "Incorrect password. Use 0000."); return; }

    setCurrentUser(email);
    closeModal();
    showMessage(globalMsg, "good", "Login successful. You can now create a ticket.");
    updateTopbar();
    enforceLoginUI();
    await renderTickets();
    scrollToCreate();
  });

  logoutBtn.addEventListener("click", async () => {
    clearCurrentUser();
    showMessage(globalMsg, "bad", "You have been logged out. Login is required to submit tickets.");
    showMessage(formMsg, "bad", "");
    showMessage(ticketsMsg, "bad", "");
    updateTopbar();
    enforceLoginUI();
    await renderTickets();
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  clearBtn.addEventListener("click", () => {
    subjectEl.value = ""; urgencyEl.value = ""; descEl.value = "";
    showMessage(formMsg, "bad", "");
    subjectEl.focus();
  });

  ticketForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const u = getCurrentUser();
    if (!u){ showMessage(formMsg, "bad", "Login is required before submitting a ticket."); openModal(); return; }

    const subject = subjectEl.value.trim();
    const urgency = urgencyEl.value.trim();
    const description = descEl.value.trim();

    const errors = validateTicketInput({subject, description, urgency});
    if (errors.length){ showMessage(formMsg, "bad", errors[0]); return; }

    try{
      await fsCreateTicket({ userEmail: u.email, subject, description, urgency });
      showMessage(formMsg, "good", "Your message has been delivered successfully. We will get back to you as soon as possible.");
      subjectEl.value = ""; urgencyEl.value = ""; descEl.value = "";
      await renderTickets();
      document.getElementById("ticketsCard")?.scrollIntoView({ behavior:"smooth", block:"start" });
    }catch(err){
      console.error(err);
      showMessage(formMsg, "bad", "Ticket submission failed. Check Firestore rules and your Firebase configuration.");
    }
  });

  // ---------- Init ----------
  updateTopbar();
  enforceLoginUI();
  await renderTickets();
</script>
