<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CloudHost Support ‚Äî Staff Console</title>
  <style>
    :root{
      --bg0:#0b1220;
      --bg1:#0e1b33;
      --card:#0f1a2e;
      --card2:#0c1627;
      --text:#e9eefc;
      --muted:#a8b4d6;
      --line:rgba(255,255,255,.10);
      --brand:#7c5cff;
      --brand2:#3dd6ed;
      --good:#34d399;
      --bad:#fb7185;
      --warn:#fbbf24;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --shadow2: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(900px 500px at 20% 10%, rgba(124,92,255,.35), transparent 55%),
        radial-gradient(900px 500px at 90% 20%, rgba(61,214,237,.25), transparent 55%),
        radial-gradient(900px 700px at 40% 90%, rgba(52,211,153,.14), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }
    button, input, select, textarea{ font:inherit; }
    a{ color:inherit; text-decoration:none; }

    .wrap{ max-width:1200px; margin:0 auto; padding:22px 16px 48px; }

    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px;
      border:1px solid var(--line);
      border-radius:22px;
      background: rgba(15,26,46,.62);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo{
      width:38px; height:38px; border-radius:14px;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 12px 30px rgba(124,92,255,.25);
      position:relative;
    }
    .logo::after{
      content:""; position:absolute; inset:10px; border-radius:10px;
      background: rgba(255,255,255,.18); transform: rotate(12deg);
    }
    .brand h1{ font-size:14px; margin:0; font-weight:800; letter-spacing:.35px; }
    .brand p{ margin:2px 0 0; font-size:12px; color:var(--muted); }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(12,22,39,.55);
      color: var(--muted);
      font-size:12px; white-space:nowrap;
    }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: var(--good);
      box-shadow: 0 0 0 6px rgba(52,211,153,.16);
    }

    .btn{
      border:1px solid var(--line);
      background: rgba(12,22,39,.55);
      color: var(--text);
      padding: 11px 13px;
      border-radius: 14px;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:10px;
      transition: transform .08s ease, background .18s ease, border-color .18s ease;
      user-select:none;
      box-shadow: 0 10px 25px rgba(0,0,0,.18);
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.20); background: rgba(12,22,39,.72); }
    .btn:active{ transform: translateY(0); }
    .btnPrimary{
      background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(61,214,237,.88));
      border-color: rgba(255,255,255,.16);
      box-shadow: 0 16px 40px rgba(124,92,255,.22);
    }
    .btnPrimary:hover{ background: linear-gradient(135deg, rgba(124,92,255,1), rgba(61,214,237,.95)); }
    .btnDanger{
      border-color: rgba(251,113,133,.25);
      background: rgba(251,113,133,.08);
    }

    .main{
      margin-top:16px;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 14px;
      align-items:start;
    }
    .card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(15,26,46,.50);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .cardHeader{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .cardHeader h2{ margin:0; font-size:14px; letter-spacing:.3px; }
    .cardHeader p{ margin:0; font-size:12px; color:var(--muted); }
    .cardBody{ padding:16px; }

    .field{ display:flex; flex-direction:column; gap:8px; margin-bottom:12px; }
    label{ font-size:12px; color:var(--muted); }
    input[type="text"], select, textarea{
      width:100%;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(12,22,39,.55);
      color: var(--text);
      padding: 12px 12px;
      outline:none;
      transition: border-color .18s ease;
    }
    textarea{ min-height: 110px; resize: vertical; }
    input[type="text"]:focus, select:focus, textarea:focus{
      border-color: rgba(124,92,255,.55);
      box-shadow: 0 0 0 5px rgba(124,92,255,.14);
    }

    .statusMsg{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(12,22,39,.45);
      display:none;
      font-size: 13px;
      line-height: 1.45;
    }
    .statusMsg.good{ border-color: rgba(52,211,153,.25); color: var(--good); display:block; }
    .statusMsg.bad{ border-color: rgba(251,113,133,.25); color: var(--bad); display:block; }

    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 12px;
    }
    .stat{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(12,22,39,.50);
      border-radius: 16px;
      padding: 12px;
    }
    .stat .k{ color:var(--muted); font-size:12px; margin:0 0 6px; }
    .stat .v{ margin:0; font-size:18px; font-weight:800; letter-spacing:.2px; }

    .listTop{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(12,22,39,.50);
      color: var(--muted);
      font-size:12px;
    }

    .ticketsList{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    .ticket{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(12,22,39,.50);
      border-radius: 16px;
      overflow:hidden;
    }
    .ticketHead{
      padding: 14px 14px 12px;
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px;
      cursor:pointer;
    }
    .ticketTitle{ display:flex; flex-direction:column; gap:6px; min-width:0; }
    .ticketTitle .subj{
      font-weight:800; font-size:14px; letter-spacing:.2px;
      white-space: nowrap; overflow:hidden; text-overflow: ellipsis;
      max-width: 64ch;
    }
    .meta{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      color: var(--muted); font-size: 12px;
    }
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .tag.good{ color: var(--good); border-color: rgba(52,211,153,.20); background: rgba(52,211,153,.06); }
    .tag.warn{ color: var(--warn); border-color: rgba(251,191,36,.20); background: rgba(251,191,36,.06); }
    .tag.bad{ color: var(--bad); border-color: rgba(251,113,133,.22); background: rgba(251,113,133,.06); }

    .ticketBody{
      border-top:1px solid rgba(255,255,255,.08);
      padding: 14px;
      display:none;
    }
    .ticketBody.open{ display:block; }
    .gridCols{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .box{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      background: rgba(15,26,46,.35);
      padding: 12px;
    }
    .box h3{
      margin:0 0 8px;
      font-size: 12px;
      color: var(--muted);
      letter-spacing:.3px;
      text-transform: uppercase;
    }
    .box p{
      margin:0;
      color: var(--text);
      font-size: 13px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .divider{ height:1px; background: rgba(255,255,255,.08); margin: 12px 0; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .row .left, .row .right{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .smallBtn{ padding: 10px 12px; border-radius: 12px; font-size: 12.5px; box-shadow:none; }

    /* Modal (Login) */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modal{
      width:min(540px, 100%);
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(15,26,46,.92);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding: 14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .modalHead h2{ margin:0; font-size:14px; letter-spacing:.2px; }
    .modalHead button{
      background: transparent; border:1px solid rgba(255,255,255,.12);
      color: var(--text);
      width: 36px; height: 36px;
      border-radius: 14px;
      cursor:pointer;
    }
    .modalBody{ padding: 16px; }
    .note{ color: var(--muted); font-size: 12.5px; line-height: 1.55; margin: 0 0 12px; }
    code{
      color: var(--text);
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      padding:2px 8px; border-radius:999px;
    }

    @media (max-width: 980px){
      .main{ grid-template-columns: 1fr; }
    }
    @media (max-width: 640px){
      .gridCols{ grid-template-columns: 1fr; }
      .ticketTitle .subj{ max-width: 32ch; }
      .btn{ width:100%; justify-content:center; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>CloudHost Support</h1>
          <p>Staff Console (Triage & Updates)</p>
        </div>
      </div>

      <div class="pill" title="Live Firestore updates enabled">
        <span class="dot" aria-hidden="true"></span>
        <span id="pillText">Disconnected</span>
      </div>

      <div style="display:flex; gap:10px; align-items:center;">
        <button class="btn" id="loginBtn">üîê Staff login</button>
        <button class="btn btnDanger" id="logoutBtn">üö™ Logout</button>
      </div>
    </div>

    <div class="main">
      <!-- Left: filters + stats -->
      <section class="card">
        <div class="cardHeader">
          <div>
            <h2>Queue controls</h2>
            <p>Search and filter tickets</p>
          </div>
          <span class="chip" id="totalChip">0 total</span>
        </div>
        <div class="cardBody">
          <div class="field">
            <label for="searchInput">Search by subject</label>
            <input id="searchInput" type="text" placeholder="Type to search..." />
          </div>

          <div class="field">
            <label for="statusFilter">Filter by status</label>
            <select id="statusFilter">
              <option value="ALL">All</option>
              <option value="New">New</option>
              <option value="In Progress">In Progress</option>
              <option value="Completed">Completed</option>
            </select>
          </div>

          <div class="field">
            <label for="priorityFilter">Priority filter</label>
            <select id="priorityFilter">
              <option value="ALL">All</option>
              <option value="HIGH_ONLY">High priority only</option>
              <option value="NOT_HIGH">Not high priority</option>
            </select>
          </div>

          <div class="stats">
            <div class="stat">
              <p class="k">New</p>
              <p class="v" id="statNew">0</p>
            </div>
            <div class="stat">
              <p class="k">In Progress</p>
              <p class="v" id="statProg">0</p>
            </div>
            <div class="stat">
              <p class="k">Completed</p>
              <p class="v" id="statDone">0</p>
            </div>
            <div class="stat">
              <p class="k">High priority</p>
              <p class="v" id="statHigh">0</p>
            </div>
          </div>

          <div class="statusMsg" id="leftMsg"></div>

          <div style="margin-top:14px; border-top:1px solid rgba(255,255,255,.08); padding-top:14px;">
            <p class="note" style="margin:0;">
              Demo staff credentials:
              <br><code>admin@cloudhost.com</code> / <code>0000</code>
              <br><code>agent@cloudhost.com</code> / <code>0000</code>
            </p>
          </div>
        </div>
      </section>

      <!-- Right: ticket list -->
      <section class="card">
        <div class="cardHeader">
          <div class="listTop">
            <div>
              <h2>Ticket inbox</h2>
              <p>Click a ticket to triage and update in real time.</p>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
              <span class="chip" id="filteredChip">0 shown</span>
              <button class="btn btnPrimary" id="refreshBtn">üîÑ Refresh</button>
            </div>
          </div>
        </div>
        <div class="cardBody">
          <div class="ticketsList" id="ticketsList"></div>
          <div class="statusMsg" id="rightMsg"></div>
        </div>
      </section>
    </div>
  </div>

  <!-- LOGIN MODAL -->
  <div class="modalOverlay" id="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <div class="modal">
      <div class="modalHead">
        <h2 id="loginTitle">Staff Login</h2>
        <button id="closeModalBtn" aria-label="Close">‚úï</button>
      </div>
      <div class="modalBody">
        <p class="note">
          This page uses a simple demo gate (not Firebase Auth) to meet the assignment requirement.
          Use the demo staff accounts below. Password is <code>0000</code>.
        </p>

        <div class="field">
          <label for="staffUser">Username (email)</label>
          <select id="staffUser">
            <option value="admin@cloudhost.com">admin@cloudhost.com</option>
            <option value="agent@cloudhost.com">agent@cloudhost.com</option>
          </select>
        </div>

        <div class="field">
          <label for="staffPass">Password</label>
          <input id="staffPass" type="text" inputmode="numeric" maxlength="8" placeholder="0000" />
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn btnPrimary" id="doLoginBtn">‚úÖ Sign in</button>
          <button class="btn" id="fillPassBtn" type="button">Fill password</button>
        </div>

        <div class="statusMsg" id="loginMsg"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, query, orderBy, onSnapshot,
      doc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ‚úÖ Same Firebase project
    const firebaseConfig = {
      apiKey: "AIzaSyCjXjoxwzs5aq2aV5308Akjs2xia-r-XxE",
      authDomain: "final-project-75dde.firebaseapp.com",
      projectId: "final-project-75dde",
      storageBucket: "final-project-75dde.firebasestorage.app",
      messagingSenderId: "750259875804",
      appId: "1:750259875804:web:4d7a2be29d6bf834b3e919"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const TICKETS_COL = "tickets";

    // Demo staff gate (simple login)
    const STAFF_USERS = new Set(["admin@cloudhost.com", "agent@cloudhost.com"]);
    const STAFF_PASS  = "0000";
    const LS_STAFF    = "cloudhost_staff_user_v1";

    function nowISO(){ return new Date().toISOString(); }
    function fmtDate(iso){
      try{
        const d = new Date(iso);
        return d.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
      }catch{ return "‚Äî"; }
    }
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function showMessage(el, type, text){
      el.classList.remove("good","bad");
      if (!text){
        el.style.display = "none";
        el.textContent = "";
        return;
      }
      el.textContent = text;
      el.classList.add(type === "good" ? "good" : "bad");
      el.style.display = "block";
    }

    function getStaff(){
      try{
        const raw = localStorage.getItem(LS_STAFF);
        if (!raw) return null;
        const u = JSON.parse(raw);
        if (!u?.email) return null;
        if (!STAFF_USERS.has(u.email)) return null;
        return u;
      }catch{ return null; }
    }
    function setStaff(email){
      localStorage.setItem(LS_STAFF, JSON.stringify({ email, at: nowISO() }));
    }
    function clearStaff(){ localStorage.removeItem(LS_STAFF); }

    // UI refs
    const pillText = document.getElementById("pillText");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const refreshBtn = document.getElementById("refreshBtn");

    const totalChip = document.getElementById("totalChip");
    const filteredChip = document.getElementById("filteredChip");
    const ticketsList = document.getElementById("ticketsList");

    const searchInput = document.getElementById("searchInput");
    const statusFilter = document.getElementById("statusFilter");
    const priorityFilter = document.getElementById("priorityFilter");

    const statNew = document.getElementById("statNew");
    const statProg = document.getElementById("statProg");
    const statDone = document.getElementById("statDone");
    const statHigh = document.getElementById("statHigh");

    const leftMsg = document.getElementById("leftMsg");
    const rightMsg = document.getElementById("rightMsg");

    // Modal
    const modalOverlay = document.getElementById("modalOverlay");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const doLoginBtn = document.getElementById("doLoginBtn");
    const fillPassBtn = document.getElementById("fillPassBtn");
    const staffUser = document.getElementById("staffUser");
    const staffPass = document.getElementById("staffPass");
    const loginMsg = document.getElementById("loginMsg");

    function openModal(){
      showMessage(loginMsg, "bad", "");
      staffPass.value = "";
      modalOverlay.style.display = "flex";
      setTimeout(() => staffPass.focus(), 50);
    }
    function closeModal(){ modalOverlay.style.display = "none"; }

    // Real-time state
    let unsubscribe = null;
    let allTickets = []; // live snapshot
    let connectedOnce = false;

    function updateConnectionPill(ok){
      pillText.textContent = ok ? "Live connected" : "Disconnected";
    }

    function computeStats(list){
      let n=0, p=0, d=0, h=0;
      for (const t of list){
        if (t.status === "New") n++;
        else if (t.status === "In Progress") p++;
        else if (t.status === "Completed") d++;
        if (t.isHighPriority) h++;
      }
      statNew.textContent = n;
      statProg.textContent = p;
      statDone.textContent = d;
      statHigh.textContent = h;
    }

    function applyFilters(list){
      const q = (searchInput.value || "").trim().toLowerCase();
      const st = statusFilter.value;
      const pr = priorityFilter.value;

      return list.filter(t => {
        const subj = String(t.subject || "").toLowerCase();
        const okQ = !q || subj.includes(q);
        const okS = (st === "ALL") || (t.status === st);
        const okP = (pr === "ALL")
          || (pr === "HIGH_ONLY" && !!t.isHighPriority)
          || (pr === "NOT_HIGH" && !t.isHighPriority);
        return okQ && okS && okP;
      });
    }

    function renderTickets(){
      const staff = getStaff();
      ticketsList.innerHTML = "";

      if (!staff){
        totalChip.textContent = "0 total";
        filteredChip.textContent = "0 shown";
        computeStats([]);
        ticketsList.innerHTML = `
          <div class="card" style="border-radius:16px; border-color: rgba(255,255,255,.10); background: rgba(12,22,39,.45)">
            <div class="cardBody">
              <h3 style="margin:0 0 8px; font-size:14px;">Staff login required</h3>
              <p style="margin:0; color: var(--muted); font-size:12.5px; line-height:1.5;">
                Please login to view and manage tickets.
              </p>
            </div>
          </div>`;
        return;
      }

      totalChip.textContent = `${allTickets.length} total`;

      const filtered = applyFilters(allTickets);
      filteredChip.textContent = `${filtered.length} shown`;

      computeStats(allTickets);

      if (filtered.length === 0){
        ticketsList.innerHTML = `
          <div class="card" style="border-radius:16px; border-color: rgba(255,255,255,.10); background: rgba(12,22,39,.45)">
            <div class="cardBody">
              <h3 style="margin:0 0 8px; font-size:14px;">No matching tickets</h3>
              <p style="margin:0; color: var(--muted); font-size:12.5px; line-height:1.5;">
                Try changing filters or clearing the search.
              </p>
            </div>
          </div>`;
        return;
      }

      for (const t of filtered){
        const statusTag = t.status === "Completed" ? "good" : (t.status === "In Progress" ? "warn" : "");
        const urgTag = t.urgency === "High" ? "bad" : (t.urgency === "Medium" ? "warn" : "");
        const highPri = t.isHighPriority ? `<span class="tag bad">High priority</span>` : `<span class="tag">Not high</span>`;
        const staffText = (t.staffResponse && t.staffResponse.trim()) ? t.staffResponse.trim() : "No staff response yet.";
        const replies = Array.isArray(t.customerReplies) ? t.customerReplies : [];

        const repliesHtml = replies.length
          ? replies.map(r => `
              <div class="box" style="padding:10px 12px; background: rgba(12,22,39,.55);">
                <h3 style="text-transform:none; letter-spacing:0; font-size:12px; margin-bottom:6px;">Customer reply ‚Äî ${fmtDate(r.at)}</h3>
                <p>${escapeHtml(r.text)}</p>
              </div>
            `).join("")
          : `<p style="margin:0; color: var(--muted); font-size:12.5px;">No customer replies yet.</p>`;

        const el = document.createElement("div");
        el.className = "ticket";
        el.innerHTML = `
          <div class="ticketHead" data-id="${t.id}">
            <div class="ticketTitle">
              <div class="subj" title="${escapeHtml(t.subject)}">${escapeHtml(t.subject)}</div>
              <div class="meta">
                <span class="tag ${urgTag}">Urgency: ${escapeHtml(t.urgency || "‚Äî")}</span>
                <span class="tag ${statusTag}">Status: ${escapeHtml(t.status || "‚Äî")}</span>
                ${highPri}
                <span class="tag">User: ${escapeHtml(t.userEmail || "‚Äî")}</span>
                <span class="tag">Updated: ${fmtDate(t.updatedAt || t.createdAt)}</span>
              </div>
            </div>
            <div class="tag">Details ‚ñæ</div>
          </div>

          <div class="ticketBody" id="body_${t.id}">
            <div class="gridCols">
              <div class="box">
                <h3>Description</h3>
                <p>${escapeHtml(t.description || "")}</p>

                <div class="divider"></div>

                <div class="row">
                  <div class="left">
                    <div class="field" style="margin:0; min-width: 220px;">
                      <label for="status_${t.id}">Update status</label>
                      <select id="status_${t.id}">
                        <option value="New" ${t.status==="New"?"selected":""}>New</option>
                        <option value="In Progress" ${t.status==="In Progress"?"selected":""}>In Progress</option>
                        <option value="Completed" ${t.status==="Completed"?"selected":""}>Completed</option>
                      </select>
                    </div>
                  </div>

                  <div class="right">
                    <button class="btn smallBtn" data-action="togglePriority" data-id="${t.id}">
                      ${t.isHighPriority ? "‚≠ê Remove high priority" : "‚≠ê Mark high priority"}
                    </button>
                    <button class="btn smallBtn btnPrimary" data-action="saveStatus" data-id="${t.id}">
                      üíæ Save changes
                    </button>
                  </div>
                </div>
              </div>

              <div class="box">
                <h3>Staff response</h3>
                <p style="margin-bottom:10px; color: var(--muted); font-size:12.5px;">
                  Current: <span style="color: var(--text)">${escapeHtml(staffText)}</span>
                </p>

                <div class="field" style="margin-bottom:0;">
                  <label for="resp_${t.id}">Write / update response</label>
                  <textarea id="resp_${t.id}" placeholder="Type your response to the customer..."></textarea>
                </div>

                <div class="row" style="margin-top:10px;">
                  <div class="left">
                    <span class="tag">Created: ${fmtDate(t.createdAt)}</span>
                    <span class="tag">Responded: ${t.staffRespondedAt ? fmtDate(t.staffRespondedAt) : "‚Äî"}</span>
                  </div>
                  <div class="right">
                    <button class="btn smallBtn btnPrimary" data-action="saveResponse" data-id="${t.id}">
                      ‚úâÔ∏è Send response
                    </button>
                  </div>
                </div>

                <div class="statusMsg" id="msg_${t.id}"></div>

                <div class="divider"></div>

                <h3>Customer replies</h3>
                <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">
                  ${repliesHtml}
                </div>
              </div>
            </div>
          </div>
        `;
        ticketsList.appendChild(el);
      }

      // expand/collapse
      ticketsList.querySelectorAll(".ticketHead").forEach(head => {
        head.addEventListener("click", () => {
          const id = head.getAttribute("data-id");
          const body = document.getElementById("body_" + id);
          body.classList.toggle("open");
          const chevron = head.querySelector(".tag:last-child");
          chevron.textContent = body.classList.contains("open") ? "Details ‚ñ¥" : "Details ‚ñæ";
        });
      });

      // action handlers
      ticketsList.querySelectorAll("button[data-action]").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          e.stopPropagation();
          const action = btn.getAttribute("data-action");
          const id = btn.getAttribute("data-id");
          const msgEl = document.getElementById("msg_" + id);

          try{
            if (!getStaff()){
              showMessage(rightMsg, "bad", "Staff login required.");
              openModal();
              return;
            }

            if (action === "togglePriority"){
              const current = allTickets.find(x => x.id === id);
              if (!current) throw new Error("Ticket not found.");
              await updateDoc(doc(db, TICKETS_COL, id), {
                isHighPriority: !current.isHighPriority,
                updatedAt: nowISO()
              });
              showMessage(msgEl, "good", "Priority updated.");
            }

            if (action === "saveStatus"){
              const statusSel = document.getElementById("status_" + id);
              const newStatus = statusSel.value;
              await updateDoc(doc(db, TICKETS_COL, id), {
                status: newStatus,
                updatedAt: nowISO()
              });
              showMessage(msgEl, "good", "Status saved.");
            }

            if (action === "saveResponse"){
              const ta = document.getElementById("resp_" + id);
              const txt = (ta.value || "").trim();
              if (txt.length < 3){
                showMessage(msgEl, "bad", "Response is too short.");
                return;
              }
              await updateDoc(doc(db, TICKETS_COL, id), {
                staffResponse: txt,
                staffRespondedAt: nowISO(),
                updatedAt: nowISO()
              });
              ta.value = "";
              showMessage(msgEl, "good", "Response sent successfully.");
            }
          } catch(err){
            console.error(err);
            showMessage(msgEl, "bad", "Update failed. Check Firestore rules and console logs.");
          }
        });
      });
    }

    function startRealtime(){
      const staff = getStaff();
      if (!staff){
        updateConnectionPill(false);
        if (unsubscribe) unsubscribe();
        unsubscribe = null;
        allTickets = [];
        renderTickets();
        return;
      }

      // live query
      const q = query(collection(db, TICKETS_COL), orderBy("updatedAt", "desc"));

      if (unsubscribe) unsubscribe();
      unsubscribe = onSnapshot(q, (snap) => {
        connectedOnce = true;
        updateConnectionPill(true);

        allTickets = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        showMessage(leftMsg, "bad", "");
        showMessage(rightMsg, "bad", "");
        renderTickets();
      }, (err) => {
        console.error(err);
        updateConnectionPill(false);
        showMessage(rightMsg, "bad", "Could not connect to Firestore. Check Firestore rules and indexes.");
      });
    }

    // filters -> rerender
    [searchInput, statusFilter, priorityFilter].forEach(el => {
      el.addEventListener("input", () => renderTickets());
      el.addEventListener("change", () => renderTickets());
    });

    // modal events
    loginBtn.addEventListener("click", openModal);
    modalOverlay.addEventListener("click", (e) => { if (e.target === modalOverlay) closeModal(); });
    closeModalBtn.addEventListener("click", closeModal);
    fillPassBtn.addEventListener("click", () => { staffPass.value = "0000"; staffPass.focus(); });

    doLoginBtn.addEventListener("click", () => {
      const email = (staffUser.value || "").trim();
      const pass  = (staffPass.value || "").trim();

      if (!STAFF_USERS.has(email)){
        showMessage(loginMsg, "bad", "Invalid staff user.");
        return;
      }
      if (pass !== STAFF_PASS){
        showMessage(loginMsg, "bad", "Incorrect password. Use 0000.");
        return;
      }

      setStaff(email);
      closeModal();
      showMessage(leftMsg, "good", "Login successful. Loading tickets...");
      startRealtime();
    });

    logoutBtn.addEventListener("click", () => {
      clearStaff();
      showMessage(leftMsg, "bad", "Logged out.");
      startRealtime();
    });

    refreshBtn.addEventListener("click", () => {
      // onSnapshot is live; this just re-renders + shows a tiny feedback
      showMessage(rightMsg, "good", "Refreshed (live mode).");
      renderTickets();
      setTimeout(() => showMessage(rightMsg, "good", ""), 1200);
    });

    // init
    startRealtime();
  </script>
</body>
</html>
