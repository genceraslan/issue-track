<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CloudHost Support â€” Insights</title>
  <style>
    :root{
      --bg0:#0b1220;
      --bg1:#0e1b33;
      --card:#0f1a2e;
      --card2:#0c1627;
      --text:#e9eefc;
      --muted:#a8b4d6;
      --line:rgba(255,255,255,.10);
      --brand:#7c5cff;
      --brand2:#3dd6ed;
      --good:#34d399;
      --bad:#fb7185;
      --warn:#fbbf24;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --shadow2: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(900px 500px at 20% 10%, rgba(124,92,255,.35), transparent 55%),
        radial-gradient(900px 500px at 90% 20%, rgba(61,214,237,.25), transparent 55%),
        radial-gradient(900px 700px at 40% 90%, rgba(52,211,153,.14), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }
    button, input, select{ font:inherit; }
    .wrap{ max-width:1100px; margin:0 auto; padding:22px 16px 48px; }

    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px;
      border:1px solid var(--line);
      border-radius:22px;
      background: rgba(15,26,46,.62);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo{
      width:38px; height:38px; border-radius:14px;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 12px 30px rgba(124,92,255,.25);
      position:relative;
    }
    .logo::after{
      content:""; position:absolute; inset:10px; border-radius:10px;
      background: rgba(255,255,255,.18); transform: rotate(12deg);
    }
    .brand h1{ font-size:14px; margin:0; font-weight:800; letter-spacing:.35px; }
    .brand p{ margin:2px 0 0; font-size:12px; color:var(--muted); }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(12,22,39,.55);
      color: var(--muted);
      font-size:12px; white-space:nowrap;
    }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: var(--good);
      box-shadow: 0 0 0 6px rgba(52,211,153,.16);
    }
    .btn{
      border:1px solid var(--line);
      background: rgba(12,22,39,.55);
      color: var(--text);
      padding: 11px 13px;
      border-radius: 14px;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:10px;
      transition: transform .08s ease, background .18s ease, border-color .18s ease;
      user-select:none;
      box-shadow: 0 10px 25px rgba(0,0,0,.18);
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.20); background: rgba(12,22,39,.72); }

    .main{
      margin-top:16px;
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      align-items:start;
    }
    .card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(15,26,46,.50);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .cardHeader{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .cardHeader h2{ margin:0; font-size:14px; letter-spacing:.3px; }
    .cardHeader p{ margin:0; font-size:12px; color:var(--muted); }
    .cardBody{ padding:16px; }

    .kpiGrid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    .kpi{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(12,22,39,.50);
      border-radius: 16px;
      padding: 14px;
      min-height: 88px;
    }
    .kpi .label{ margin:0 0 6px; color:var(--muted); font-size:12px; }
    .kpi .value{ margin:0; font-size:22px; font-weight:900; letter-spacing:.2px; }
    .kpi .sub{ margin:6px 0 0; color:rgba(233,238,252,.70); font-size:12px; }

    .barWrap{
      display:flex; flex-direction:column; gap:10px;
    }
    .barRow{
      display:grid;
      grid-template-columns: 110px 1fr 62px;
      gap:10px;
      align-items:center;
    }
    .barRow .name{ color: var(--muted); font-size:12px; }
    .bar{
      height: 10px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
    }
    .fill{ height:100%; width:0%; border-radius:999px; background: linear-gradient(90deg, rgba(124,92,255,.95), rgba(61,214,237,.85)); }
    .barRow .count{ text-align:right; font-size:12px; color: rgba(233,238,252,.75); }

    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .tag.good{ color: var(--good); border-color: rgba(52,211,153,.20); background: rgba(52,211,153,.06); }
    .tag.warn{ color: var(--warn); border-color: rgba(251,191,36,.20); background: rgba(251,191,36,.06); }
    .tag.bad{ color: var(--bad); border-color: rgba(251,113,133,.22); background: rgba(251,113,133,.06); }

    .statusMsg{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(12,22,39,.45);
      display:none;
      font-size: 13px;
      line-height: 1.45;
    }
    .statusMsg.good{ border-color: rgba(52,211,153,.25); color: var(--good); display:block; }
    .statusMsg.bad{ border-color: rgba(251,113,133,.25); color: var(--bad); display:block; }

    .list{
      display:flex; flex-direction:column; gap:10px;
      margin-top:10px;
    }
    .item{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(12,22,39,.50);
      border-radius: 16px;
      padding: 12px;
    }
    .item .title{
      margin:0 0 6px; font-weight:800; font-size:13px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .item .meta{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
      color: var(--muted); font-size:12px;
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .kpiGrid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>CloudHost Support</h1>
          <p>Insights Dashboard</p>
        </div>
      </div>

      <div class="pill" title="Live Firestore updates enabled">
        <span class="dot" aria-hidden="true"></span>
        <span id="pillText">Connectingâ€¦</span>
      </div>

      <button class="btn" id="refreshBtn">ðŸ”„ Refresh</button>
    </div>

    <main class="main">
      <section class="card">
        <div class="cardHeader">
          <div>
            <h2>Operational KPIs</h2>
            <p>Real-time metrics derived from Firestore /tickets</p>
          </div>
          <span class="tag" id="lastUpdated">Last updated: â€”</span>
        </div>
        <div class="cardBody">
          <div class="kpiGrid">
            <div class="kpi">
              <p class="label">Tickets created (last 24h)</p>
              <p class="value" id="kpi24h">0</p>
              <p class="sub">New tickets submitted in the past 24 hours</p>
            </div>
            <div class="kpi">
              <p class="label">High priority</p>
              <p class="value" id="kpiHigh">0</p>
              <p class="sub">Tickets marked as high priority</p>
            </div>
            <div class="kpi">
              <p class="label">Total tickets</p>
              <p class="value" id="kpiTotal">0</p>
              <p class="sub">All tickets in the system</p>
            </div>
          </div>

          <div style="margin-top:14px" class="grid">
            <div class="card" style="box-shadow:none; background: rgba(12,22,39,.20); border-color: rgba(255,255,255,.08);">
              <div class="cardHeader">
                <div>
                  <h2>Status distribution</h2>
                  <p>New / In Progress / Completed</p>
                </div>
                <span class="tag" id="statusSummary">â€”</span>
              </div>
              <div class="cardBody">
                <div class="barWrap">
                  <div class="barRow">
                    <div class="name">New</div>
                    <div class="bar"><div class="fill" id="barNew"></div></div>
                    <div class="count" id="countNew">0</div>
                  </div>

                  <div class="barRow">
                    <div class="name">In Progress</div>
                    <div class="bar"><div class="fill" id="barProg"></div></div>
                    <div class="count" id="countProg">0</div>
                  </div>

                  <div class="barRow">
                    <div class="name">Completed</div>
                    <div class="bar"><div class="fill" id="barDone"></div></div>
                    <div class="count" id="countDone">0</div>
                  </div>
                </div>

                <div class="statusMsg" id="distMsg"></div>
              </div>
            </div>

            <div class="card" style="box-shadow:none; background: rgba(12,22,39,.20); border-color: rgba(255,255,255,.08);">
              <div class="cardHeader">
                <div>
                  <h2>Recent activity</h2>
                  <p>Latest updated tickets (preview)</p>
                </div>
                <span class="tag">Top 8</span>
              </div>
              <div class="cardBody">
                <div class="list" id="recentList"></div>
                <div class="statusMsg" id="recentMsg"></div>
              </div>
            </div>
          </div>

        </div>
      </section>
    </main>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCjXjoxwzs5aq2aV5308Akjs2xia-r-XxE",
      authDomain: "final-project-75dde.firebaseapp.com",
      projectId: "final-project-75dde",
      storageBucket: "final-project-75dde.firebasestorage.app",
      messagingSenderId: "750259875804",
      appId: "1:750259875804:web:4d7a2be29d6bf834b3e919"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const TICKETS_COL = "tickets";

    const pillText = document.getElementById("pillText");
    const refreshBtn = document.getElementById("refreshBtn");
    const lastUpdated = document.getElementById("lastUpdated");

    const kpi24h = document.getElementById("kpi24h");
    const kpiHigh = document.getElementById("kpiHigh");
    const kpiTotal = document.getElementById("kpiTotal");

    const countNew = document.getElementById("countNew");
    const countProg = document.getElementById("countProg");
    const countDone = document.getElementById("countDone");

    const barNew = document.getElementById("barNew");
    const barProg = document.getElementById("barProg");
    const barDone = document.getElementById("barDone");

    const statusSummary = document.getElementById("statusSummary");
    const distMsg = document.getElementById("distMsg");

    const recentList = document.getElementById("recentList");
    const recentMsg = document.getElementById("recentMsg");

    function nowISO(){ return new Date().toISOString(); }
    function fmtDate(iso){
      try{
        const d = new Date(iso);
        return d.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
      }catch{ return "â€”"; }
    }
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function showMessage(el, type, text){
      el.classList.remove("good","bad");
      if (!text){
        el.style.display = "none";
        el.textContent = "";
        return;
      }
      el.textContent = text;
      el.classList.add(type === "good" ? "good" : "bad");
      el.style.display = "block";
    }

    let unsubscribe = null;
    let lastSnapshotDocs = [];

    function computeAndRender(tickets){
      const total = tickets.length;
      const now = Date.now();
      const cutoff = now - (24 * 60 * 60 * 1000);

      let n=0, p=0, d=0, high=0, last24=0;

      for (const t of tickets){
        const st = t.status || "New";
        if (st === "New") n++;
        else if (st === "In Progress") p++;
        else if (st === "Completed") d++;

        if (t.isHighPriority) high++;

        const created = Date.parse(t.createdAt || "");
        if (!Number.isNaN(created) && created >= cutoff) last24++;
      }

      kpiTotal.textContent = total;
      kpiHigh.textContent = high;
      kpi24h.textContent = last24;

      countNew.textContent = n;
      countProg.textContent = p;
      countDone.textContent = d;

      statusSummary.textContent = `New ${n} â€¢ In Progress ${p} â€¢ Completed ${d}`;

      const max = Math.max(1, total);
      barNew.style.width  = `${Math.round((n / max) * 100)}%`;
      barProg.style.width = `${Math.round((p / max) * 100)}%`;
      barDone.style.width = `${Math.round((d / max) * 100)}%`;

      if (total === 0){
        showMessage(distMsg, "bad", "No tickets found yet. Create tickets from public.html to see metrics here.");
      } else {
        showMessage(distMsg, "bad", "");
      }

      // Recent activity (top 8 by updatedAt ordering already)
      const top = tickets.slice(0, 8);
      recentList.innerHTML = "";

      if (top.length === 0){
        recentList.innerHTML = `
          <div class="item">
            <p class="title">No recent activity</p>
            <div class="meta">Create tickets or update statuses in staff.html.</div>
          </div>`;
        return;
      }

      for (const t of top){
        const st = t.status || "New";
        const stTag = st === "Completed" ? "good" : (st === "In Progress" ? "warn" : "");
        const urg = t.urgency || "â€”";
        const urgTag = urg === "High" ? "bad" : (urg === "Medium" ? "warn" : "");
        const priTag = t.isHighPriority ? "bad" : "";

        const item = document.createElement("div");
        item.className = "item";
        item.innerHTML = `
          <p class="title" title="${escapeHtml(t.subject || "Untitled")}">${escapeHtml(t.subject || "Untitled")}</p>
          <div class="meta">
            <span class="tag ${stTag}">Status: ${escapeHtml(st)}</span>
            <span class="tag ${urgTag}">Urgency: ${escapeHtml(urg)}</span>
            <span class="tag ${priTag}">${t.isHighPriority ? "High priority" : "Normal"}</span>
            <span class="tag">User: ${escapeHtml(t.userEmail || "â€”")}</span>
            <span class="tag">Updated: ${fmtDate(t.updatedAt || t.createdAt)}</span>
          </div>
        `;
        recentList.appendChild(item);
      }
    }

    function connectRealtime(){
      pillText.textContent = "Connectingâ€¦";
      showMessage(recentMsg, "bad", "");
      showMessage(distMsg, "bad", "");

      const q = query(collection(db, TICKETS_COL), orderBy("updatedAt", "desc"));

      if (unsubscribe) unsubscribe();
      unsubscribe = onSnapshot(q, (snap) => {
        pillText.textContent = "Live connected";
        lastUpdated.textContent = `Last updated: ${fmtDate(nowISO())}`;

        lastSnapshotDocs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        computeAndRender(lastSnapshotDocs);
      }, (err) => {
        console.error(err);
        pillText.textContent = "Disconnected";
        showMessage(recentMsg, "bad", "Could not connect to Firestore. Check Firestore rules and indexes.");
      });
    }

    refreshBtn.addEventListener("click", () => {
      // Real-time already; this forces a UI refresh from last snapshot and shows timestamp.
      lastUpdated.textContent = `Last updated: ${fmtDate(nowISO())}`;
      computeAndRender(lastSnapshotDocs);
    });

    // init
    connectRealtime();
  </script>
</body>
</html>
